<section>
  <div class="row">
    <div class="span4 column sidebar left" id="profile_sidebar">
      <div id="photo_section" class="editable profile_photo" data-placement="right" data-title="Change your photo" data-form="photo_form">
        <%= render partial: "photo", locals: {user: @user} %>
      </div>
      <%= render :partial => "shared/buddies_preview", :locals => {:user => @user} %>
      <div>
        <%= link_to "Report this profile", "#" %>
      </div>
      <div>
        <%= link_to "Block", "#" %>
      </div>
    </div>
    <div class="span12 column profile_main_content">
      <div id="profile_personal_info" class="left">
        <h1><%= @user.name %></h1>
        <div id="affiliations_section" class="editable" data-placement="below" data-title="Affiliation Details" data-form="affiliations_form">
          <%= render partial: "affiliations", locals: {user: @user} %>
        </div>
        <div id="bio_section" class="left editable" data-placement="below" data-title="Personal Bio" data-form="bio_form">
          <%= render partial: "bio", locals: {user: @user} %>
        </div>
      </div>
      <div class="profile_ratings left">
        <div id="gpa_section" class="rating_block gpa left editable" data-placement="left" data-title="Update Your GPA" data-form="gpa_form">
          <%= render partial: "gpa", locals: {user: @user} %>
        </div>
        <%= render :partial => "votes/rating", :locals => {:user => @user} %>
        <div class="clear"></div>
        <div class="stats">
            <ul class="unstyled">
              <li>
                <span class="count left"><%= @user.study_sessions.count %></span> Studyhalls Created
                <div class="clear"></div>
              </li>
              <li>
                <span class="count left"><%= @user.notes.shared.count %></span> Notes Shared 
                <div class="clear"></div>
              </li>
            </ul>
        </div>
      </div>
      <div class="clear"></div>
      <div id="profile_user_items">
        <div id="profile_tabs">
          <ul class="tabs">
            <li class="active"><a data-rel="courses_tab" href="#">Courses <span>(<%= @user.offerings.count %>)</span></a></li>
            <li><a data-rel="notes_tab" href="#">Notes <span>(<%= @user.notebooks.viewable_by(current_user).count %>)</span></a></li>
            <li><a data-rel="studyhalls_tab" href="#">Studyhalls <span>(<%= @user.study_sessions.viewable_by(current_user).count %>)</span></a></li>
          </ul>
          <ul id="courses_tab" class="courses course_list tab_contents editable">
            <% @user.offerings.each do |course| %>
              <li data-rel="<%= class_url(course) %>" id="course_<%= course.id %>" class="linked_item course">
                <span><%= course.course.title %></span>
                <% if current_user %>
                  <%= link_to "", user_drop_class_path(current_user,course), class: "drop_course_link", "data-course_id" => course.id %>
                <% end %>
              </li>
            <% end %>
          </ul>
          <ul id="notes_tab" class="notes notebook_list tab_contents" style="display:none">
            <% @user.notebooks.viewable_by(current_user).each do |notebook| %>
              <li data-rel="<%= notebook_notes_url(notebook) %>" class="linked_item notebook">
                <span><%= notebook.name %></span>
              </li>
            <% end %>
          </ul>
          <ul id="studyhalls_tab" class="studyhalls notebook_list tab_contents" style="display:none">
            <% @user.study_sessions.viewable_by(current_user).each do |study_session| %>
              <li data-rel="<%= url_for(study_session) %>" class="linked_item study_session">
                <div class="attendees">
                  <% study_session.users.first(3).each do |user| %>
                    <%= link_to image_tag(user.avatar_url(:thumb)), user, :title => user.name %>
                  <% end %>
                </div>
                <% if study_session.name.blank? %>
                  <%= link_to study_session.created_at.strftime("%m/%d/%Y"), study_session, class: "name" %>
                <% else %>
                  <%= link_to truncate(study_session.name, length: 28), study_session, class: "name" %>
                  <span class="date"><%= study_session.created_at.strftime("%m/%d/%Y") %></span>
                <% end %>
              </li>
            <% end %>
          </ul>
        </div>
      </div>
    </div>
  </div>
</section>
<div id="profile_forms" style="display:none">
  <div class="form" id="affiliations_form">
    <%= form_for @user, :remote => true, :html => {:class => "form-stacked with_columns", :id => "edit_personal_info_form", :multipart => true} do |f| %>
      <input type="hidden" name="form_id" value="affiliations_form">
      <div class="input">
        <%= f.label :School %>
        <%= f.collection_select :school_id, School.all, :id, :name, {}, :class => "" %>
      </div>
      <!--div class="input">
        <%= f.label :sports_and_clubs %>
        <%= text_field_tag "extracurriculars_list", @user.extracurriculars_list, :class => "extracurriculars_list" %>
      </div-->
      <div class="clearfix input gender">
        <%= f.label :Gender %>
        <%= f.select( "gender", %w[Male Female], {:prompt => "Select"})%>
      </div>
      <div class="clearfix input fraternity <%= 'hide' if @user.female? %>">
        <%= f.label :fraternity %>
        <%= f.text_field :fraternity %>
      </div>
      <div class="clearfix input sorority <%= 'hide' if @user.male? %>">
        <%= f.label :sorority %>
        <%= f.text_field :sorority %>
      </div>
      <div class="clearfix input">
        <%= f.label :'major/minor' %>
        <%= f.text_field :major %>
      </div>
      <div class="input clearfix">
        <%= f.submit "Save Changes", :class => "btn primary save" %>
        <%= link_to "Cancel", "#", :class => "btn close_modal" %>
      </div>
    <% end %>
  </div>

  <div class="form" id="gpa_form">
    <%= form_for @user, :remote => true, :html => {:class => "form-stacked with_columns", :id => "edit_gpa_form", :multipart => true} do |f| %>
      <input type="hidden" name="form_id" value="gpa_form">
      <div class="input">
        <%= f.label :GPA %>
        <%= f.text_field :gpa %>
      </div>
      <div class="input clearfix">
        <%= f.submit "Save Changes", :class => "btn primary save" %>
        <%= link_to "Cancel", "#", :class => "btn close_modal" %>
      </div>
    <% end %>
  </div>

  <div class="form" id="bio_form">
    <%= form_for @user, :remote => true, :html => {:class => "form-stacked with_columns", :id => "edit_bio_form", :multipart => true} do |f| %>
      <input type="hidden" name="form_id" value="bio_form">
      <div class="input">
        <%= f.label :bio %>
        <%= f.text_area :bio, :rows => 10 %>
      </div>
      <div class="input clearfix">
        <%= f.submit "Save Changes", :class => "btn primary save" %>
        <%= link_to "Cancel", "#", :class => "btn close_modal" %>
      </div>
    <% end %>
  </div>

  <div class="form" id="photo_form">
    <%= form_for @user, :remote => true, :html => {:class => "form-stacked with_columns", :id => "edit_profile_photo_form", :multipart => true} do |f| %>
      <input type="hidden" name="form_id" value="photo_form">
      <div class="input">
        <%= f.label :Your_photo %>
        <%= f.file_field :avatar %>
      </div>
      <% if @user.has_avatar? %>
        <div class="input clearfix">
          <%= f.label "Delete Image" %>
          <div class="input"><%= check_box_tag :delete_avatar %></div>
        </div>
      <% end %>
      <div class="input clearfix">
        <%= f.submit "Save Changes", :class => "btn primary save" %>
        <%= link_to "Cancel", "#", :class => "btn close_modal" %>
      </div>
    <% end %>
  </div>
</div>
<% if current_user %>
  <% @user.offerings.each do |course| %>
    <div id="course_<%= course.id %>_modal" data-rel="course_<%= course.id %>" class="course_modal modal hide fade" style="display:none">
      <div class="modal-header">
        <h2>Are you sure?</h2>
      </div>
      <div class="modal-body">
        <p>Do you want to drop <%= course.course.title %>?</p>
        <%= link_to "Yes, drop it!", user_drop_class_path(current_user, course), class: "btn primary", method: :delete, :remote => true %>
        <%= link_to "Cancel", "#", :class => "btn close_modal", "data-id" => "course_#{course.id}_modal" %>
      </div>
    </div>
  <% end %>
<% end %>
<script type="text/javascript">
  var hidePopovers = function(){
    $(".editable.edit.active").each(function(){
      $(this).popover("hide");
    });
  }

  var cloneForm = function(editable){
    var form_id = $(editable).data("form");
    var form = $("#"+form_id).clone();
    return form.first().html();
  }
  
  var initChosen = function(){
    chosenable = $(".popover #user_school_id, .popover #user_gender");
    chosenable.addClass("chzn-select");
    chosenable.chosen();
    $(".popover #user_gender ").chosen().change(function(){
      $('.fraternity, .sorority').toggleClass("hide");
    });
  }

  $(document).ready(function(){

    $(".tabs li").each(function(){
      var li = $(this);
      var link = li.children().first();
      if(li.hasClass("active"))
        $("#"+link.data("rel")).show();
      link.click(function(e){
        var clicked_link = $(this);
        $(".tabs li").removeClass("active");
        clicked_link.parent().addClass("active");
        $(".tab_contents").hide();
        $("#"+clicked_link.data("rel")).show();
        e.preventDefault();
      });
    });

    $(".course_list").jScrollPane();

    $(".users-show").delegate(".edit .drop_course_link","click",function(e){
      var modal_id = "#course_" + $(this).data("course_id") + "_modal";
      $(modal_id).modal({keyboard: true,
                         show: true,
                         backdrop: true});
      e.stopPropagation();
      e.preventDefault();
    });

    $(".linked_item").click(function(e){
      if(!$(this).closest(".editable").hasClass("edit"))
        window.location = $(this).data("rel");
      else
        e.preventDefault();
    });

    $(".edit_button").click(function(e){
      hidePopovers();
      $(".editable").toggleClass("edit");
      e.preventDefault();
    });

    $(".users-show").delegate(".editable.edit","click",function(e){
      if(!$(this).hasClass("tab_contents")){
        var editable = $(this);
        hidePopovers();
        editable.addClass("active");
        editable.popover({trigger: "manual",
                          placement: editable.data("placement"),
                          html: true,
                          offset: 10,
                          horizontalOffset: 10,
                          title: function(){return editable.data("title")},
                          content: function(){ return cloneForm(editable)}});
        editable.popover("show");
        initChosen(editable.popover);
        //$("select.chzn-select").chosen();
      }
      e.preventDefault();
    });

    $(".users-show").delegate("a.close_modal","click",function(e){
      hidePopovers();
      console.log($(this).data("id"));
      $("#"+$(this).data("id")).modal("hide");
    });
  });
</script>
