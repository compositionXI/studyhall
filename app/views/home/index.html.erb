<header class="home-header row">
  <div class="user_greeting span4">
    <%= link_to (image_tag @current_user.avatar_url("medium")), @current_user %>
    <h3>Hi, 
    <%= link_to @current_user.first_name, @current_user %>!
    </h3>
  </div>
  <% if flash[:notice] %>
    <div class="alert alert-message success span7">
        <a class="close" href="#">Ã—</a>
        <%= flash[:notice] %>
        <%= link_to "Complete Your Profile", custom_user_path(current_user.custom_url, :tour => true) unless current_user.try(:profile_complete?) %>
    </div>
  <% else %>
  <% end %>
</header>
<aside class="sidebar">
  <div class="standard_actions tourable" data-popover-id="standard_actions_tour">
      <%= link_to "Start a Studyhall", new_study_session_path(:link_id => "new_study_session_button1"), :id => "new_study_session_button1", :class => "btn primary large popover_button", :remote => true %>
      <%= link_to "Take Notes", new_note_path, :class => "btn large" %>
      <%= link_to "Upload", notes_path(:trigger_upload => 1), :class => "btn large popover_button show_button", :id => "upload_note_button" %>
  </div>
  <%= render :partial => "shared/buddies_preview", :locals => {:user => @current_user} %>
</aside>
<div class="main_content">
  <div id="home_tabs">
    <ul class="tabs">
      <li class="active tourable" data-popover-id="activity_tour"><%= link_to "Your Activity <small>(#{current_user.activity.count})</small>".html_safe, '#activities_tab' %></li>
      <li class="tourable" data-popover-id="campus_news_tour"><%= link_to "Campus News <small>(#{current_user.school.try(:latest_news).try(:count) || 0 })</small>".html_safe, '#news_tab' %></li>
    </ul>
    <ul id="activities_tab" class="activity-list active" style="width:700px; height: 250px; overflow-y:hidden;">
      <% if current_user.activity.any? %>
        <% current_user.activity.each do |message| %>
          <li class="activity_message">
            <%= link_to image_tag(message.activist.photo_url(:medium)), message.activist, title: message.activist.title_name if message.activist %>
            <%= message.body.html_safe %>
          </li>
        <% end %>
      <% else %>
        <li><p>No recent activity</p></li>
      <% end %>
    </ul>
    <ul id="news_tab" class="news-list">
      <% if current_user.school.present? %>
        <% if current_user.school.latest_news.any? %>
          <% current_user.school.latest_news.each do |news| %>
            <li><%= link_to truncate(news.title, length: 120), news.link, title: news.title, target: '_blank' %></li>
          <% end %>
        <% else %>
          <li><p>No recent news</p></li>
        <% end %>
      <% else %>
        <li><p>No school</p></li>
      <% end %>
    </ul>
  </div>
  <section class="tourable courses <%= items_layout %>" data-popover-id="courses_tour">
    <header>
      <h3>Courses</h3>
    </header>
    <ol class="course_list">
      <%= render partial: 'users/course_list', collection: @current_user.offerings, as: :offering, :locals => {:wrapper_class => "wrapper_large"} %>
      <li class="add">
        <%= link_to "#", :id => "add_course_button" do %>
          <span>Add a course</span>
        <% end %>
      </li>
    </ol>
  </section>
</div>
<%= render :partial => 'tour' if @tour %>

<div class="tour_popover" id="invitation_tour" data-title="Invite Buddies <small>We promise not to spam</small>" style="display: none;">
  <%= render :partial => 'shared/invite_buddies_popover', :locals => { :user => current_user } %>
</div>
<% unless @tour %>
  <script type="text/javascript">
    $(function(){
      $(".activate_invitation").click(function(){
        var invitation_tour = $("#invitation_tour").clone();
        invitation_tour.find("#gmail_invite_modal").remove()
        invitation_tour.find("#facebook_connect_modal").remove()
        invitation_tour.find(".popover-footer div.input").removeClass("input");
        invitation_tour.find("input.save").live('click', function(){
          $(".activate_invitation").popover('hide');
        });
        $(this).popover({trigger: "manual",
                          placement: 'below-right',
                          html: true,
                          offset: 5,
                          horizontalOffset: 110,
                          title: function(){return invitation_tour.data('title');},
                          content: function(){ return invitation_tour.html(); }});
        $(this).popover("show");
      });
    });
  </script>
<% end %>

<div id="course_select_container" style="display:none;">
  <%= render :partial => 'classes/form' %>
</div>

<script type="text/javascript">
  $(document).ready(function(){

    var placement = "right";
    var length = $('.course_list').children().length;
    var bottom_size = length % 4;
    if(bottom_size == 1){ placement = "right"; }else{ placement = "left"; }
    //updating course select
    
    var course_select_content = $("#course_select_container").clone();
    var popover_attr = {
      trigger: "manual",
      placement: placement,
      offset: 10,
      horizontalOffset: 25,
      html: true,
      title: function(){return "Add A New Course";},
      content: function(){return course_select_content.html();}
    };

    
    $("#add_course_button").live('click', function(){
      $("#add_course_button").popover(popover_attr);
      $("#add_course_button").popover("show");
      $("select.chzn-select").chosen();
      styleFileInputs();
      $("#new_class_post .fake-file").css({position: "relative", top: "-34px"});
      initWindowResize();
      return false;
    });
    
    $('a.cancel_course_popover').live('click', function(){
      $("#add_course_button").popover("hide");
      return false;
    });
    
    var top_choice = 0
    $('#.dept_choose .chzn-results li').live('click', function(){
      top_choice = $('#class_department_chzn a span');
      $.get('/classes/show',
        { dept_name: top_choice.html() },
        function(data){
          $('.number_choose').html('<select id="class_number" name="class[number][]" style="width: 130px; visibility:hidden;"></select>');
          $('#class_number').html( data );
          $('#class_number').css('visibility','visible').addClass('chzn-select').chosen();
      });
    });
    
    $('.add_course_final').live('click', function(){
      length = $('.course_list').children().length;
      bottom_size = length % 4;
      if(bottom_size == 0){ placement = "right"; }else{ placement = "left"; }
      popover_attr['placement'] = placement;
      var days = '';
      if($('#d1').prop('checked')){ days += '1'; };
      if($('#d2').prop('checked')){ days += '2'; };
      if($('#d3').prop('checked')){ days += '3'; };
      if($('#d4').prop('checked')){ days += '4'; };
      if($('#d5').prop('checked')){ days += '5'; };
      var start = $('#class_start_time').val();
      var end = $('#class_end_time').val();
      var course_name = $('.chzn-single span').html();
      var option_selector = "option:contains('"+course_name+"')";
      var course = $(option_selector).val();
      if(days != '' && start != end && course_name != 'Select an Option'){
        $.ajax({
          url: '/calendars',
          type: 'POST',
          data: "days=" + days + "&start_time=" + start + "&end_time=" + end + "&course_id=" + course + "&course_name=" + course_name
        });
      };
    });


  var trigger_hide_modal = function() {
    $("#view_all_buddies").modal('hide');
  }
  
  });

</script>
